<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Michigan FOIA Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    margin: 0;
    font-family: Arial, Helvetica, sans-serif;
    background: #f4f6f8;
}

header {
    background: #0e1c32;
    color: white;
    padding: 20px;
}

header h1 {
    margin: 0;
    font-size: 24px;
}

main {
    max-width: 1000px;
    margin: 40px auto;
    padding: 0 20px;
}

.card {
    background: white;
    padding: 25px;
    border-radius: 6px;
    box-shadow: 0 2px 12px rgba(0,0,0,.08);
    margin-bottom: 30px;
}

.actions {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

button {
    padding: 12px 18px;
    border: none;
    border-radius: 4px;
    font-weight: bold;
    cursor: pointer;
}

.primary {
    background: #0e1c32;
    color: white;
}

header {
    text-align: center;
}

.secondary {
    background: #e1e5eb;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    padding: 12px;
    border-bottom: 1px solid #ddd;
    text-align: left;
}

.status {
    font-weight: bold;
}
</style>
</head>

<body>

<header>
    <h1>FOIA Dashboard</h1>
    <p id="userInfo"></p>
</header>



<main>

<div class="card">
    <div class="actions">
        <button class="primary" onclick="newRequest()">Submit FOIA Request</button>
        <button class="secondary" onclick="logout()">Log Out</button>
    </div>
</div>

<div class="card">
    <h2>Your FOIA Requests</h2>
    <table>
        <thead>
            <tr>
                <th>Request ID</th>
                <th>Subject</th>
                <th>Status</th>
                <th>Submitted</th>
            </tr>
        </thead>
        <tbody id="requestsTable">
            <tr><td colspan="4">Loading...</td></tr>
        </tbody>
    </table>
</div>

</main>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRpPNwgf7vqVsCaG02stM4kRrOsKOAsK_RZXjUnGieqrKJXQzuZvlpC1n1Z7U0kUE36EC3aLnWv677d/pub?output=csv";

document.addEventListener("DOMContentLoaded", loadRequests);

async function loadRequests() {
    const table = document.getElementById("requestsTable");
    table.innerHTML = "<tr><td colspan='4'>Loading...</td></tr>";

    try {
        const response = await fetch(CSV_URL);
        const text = await response.text();
        const rows = parseCSV(text);

        table.innerHTML = "";

        if (rows.length <= 1) {
            table.innerHTML = "<tr><td colspan='4'>No FOIA requests found.</td></tr>";
            return;
        }

        // Remove header row
        rows.shift();

        rows.forEach((row, index) => {
            const [
                firstName,     // A
                lastName,      // B
                jurisdiction,  // C
                department,    // D
                discord,       // E
                email,         // F
                description,   // G
                startDate,     // H
                endDate,       // I
                format,        // J
                contactEmail   // K
            ] = row;

            const requestId = index + 1;

            const previewDescription = description.length > 60
                ? description.substring(0, 60) + "..."
                : description;

            const tr = document.createElement("tr");
            tr.style.cursor = "pointer";

            tr.innerHTML = `
                <td>${requestId}</td>
                <td>${previewDescription}</td>
                <td>Submitted</td>
                <td>${startDate} to ${endDate}</td>
            `;

            tr.addEventListener("click", () => {
                toggleDetails(tr, {
                    firstName,
                    lastName,
                    jurisdiction,
                    department,
                    discord,
                    email,
                    description,
                    startDate,
                    endDate,
                    format,
                    contactEmail
                });
            });

            table.appendChild(tr);
        });

    } catch (error) {
        table.innerHTML = "<tr><td colspan='4'>Error loading requests.</td></tr>";
        console.error(error);
    }
}

function toggleDetails(row, data) {
    if (row.nextSibling && row.nextSibling.classList && row.nextSibling.classList.contains("details-row")) {
        row.nextSibling.remove();
        return;
    }

    const detailsRow = document.createElement("tr");
    detailsRow.classList.add("details-row");

    detailsRow.innerHTML = `
        <td colspan="4">
            <strong>Requester:</strong> ${data.firstName} ${data.lastName}<br><br>
            <strong>Jurisdiction:</strong> ${data.jurisdiction}<br>
            <strong>Department/Office:</strong> ${data.department}<br>
            <strong>Discord:</strong> ${data.discord}<br>
            <strong>Email:</strong> ${data.email}<br><br>
            <strong>Date Range:</strong> ${data.startDate} to ${data.endDate}<br>
            <strong>Access & Format:</strong> ${data.format}<br>
            <strong>Contact Email:</strong> ${data.contactEmail}<br><br>
            <strong>Description of Records:</strong><br>
            ${data.description}
        </td>
    `;

    row.after(detailsRow);
}

function parseCSV(text) {
    const rows = [];
    const lines = text.split("\n");

    for (let line of lines) {
        const values = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
        if (values) {
            rows.push(values.map(v => v.replace(/^"|"$/g, "").trim()));
        }
    }

    return rows;
}

// Navigation
window.newRequest = () => {
    window.location.href = "/records/foia/request/new.html";
};

window.logout = () => {
    window.location.href = "/records/foia/login/";
};
</script>


</body>
</html>