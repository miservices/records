<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Michigan FOIA Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    margin: 0;
    font-family: Arial, Helvetica, sans-serif;
    background: #f4f6f8;
}

header {
    background: #0e1c32;
    color: white;
    padding: 25px;
    text-align: center;
}

header h1 {
    margin: 0;
    font-size: 26px;
}

main {
    max-width: 1100px;
    margin: 40px auto;
    padding: 0 20px;
}

.card {
    background: white;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 4px 18px rgba(0,0,0,.08);
    margin-bottom: 30px;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th {
    background: #f1f3f6;
    text-align: left;
    padding: 14px;
    font-size: 14px;
    letter-spacing: .5px;
}

td {
    padding: 14px;
    border-bottom: 1px solid #e2e6ea;
}

tr:hover {
    background: #f9fbfd;
    cursor: pointer;
}

.status-pill {
    padding: 6px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    display: inline-block;
}

.status-Submitted { background:#dbeafe; color:#1e40af; }
.status-Processing { background:#fef3c7; color:#92400e; }
.status-Completed { background:#dcfce7; color:#166534; }

.detail-container {
    display: none;
}

.detail-header {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 20px;
}

.detail-grid {
    display: grid;
    grid-template-columns: 200px 1fr;
    row-gap: 12px;
}

.label {
    font-weight: bold;
    color: #374151;
}

.description-box {
    background: #f9fafb;
    padding: 18px;
    border-radius: 6px;
    margin-top: 15px;
    white-space: pre-wrap;
}

.back-link {
    display: inline-block;
    margin-bottom: 20px;
    color: #1e40af;
    text-decoration: none;
    font-weight: bold;
}
</style>
</head>

<body>

<header>
    <h1>Michigan FOIA Dashboard</h1>
</header>

<main>

<div class="card" id="listView">
    <h2>FOIA Requests</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Status</th>
                <th>Date Submitted</th>
                <th>First Name</th>
                <th>Last Name</th>
            </tr>
        </thead>
        <tbody id="requestsTable">
            <tr><td colspan="5">Loading...</td></tr>
        </tbody>
    </table>
</div>

<div class="card detail-container" id="detailView">
    <a href="/records/foia/dashboard/" class="back-link">‚Üê Back to Dashboard</a>
    <div id="detailContent"></div>
</div>

</main>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRpPNwgf7vqVsCaG02stM4kRrOsKOAsK_RZXjUnGieqrKJXQzuZvlpC1n1Z7U0kUE36EC3aLnWv677d/pub?output=csv";

let allRequests = [];

document.addEventListener("DOMContentLoaded", loadRequests);

async function loadRequests() {
    const table = document.getElementById("requestsTable");

    try {
        const response = await fetch(CSV_URL);
        const text = await response.text();
        const rows = parseCSV(text);

        rows.shift(); // remove header

        allRequests = rows.map(row => ({
            id: row[0],
            status: row[1],
            firstName: row[2],
            lastName: row[3],
            dateSubmitted: row[4],
            jurisdiction: row[5],
            department: row[6],
            discord: row[7],
            email: row[8],
            description: row[9],
            startDate: row[10],
            endDate: row[11],
            format: row[12],
            delivery: row[13],
            assigned: row[14]
        }));

        renderTable();
        checkHash();

    } catch (error) {
        table.innerHTML = "<tr><td colspan='5'>Error loading requests.</td></tr>";
        console.error(error);
    }
}

function renderTable() {
    const table = document.getElementById("requestsTable");
    table.innerHTML = "";

    allRequests.forEach(req => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
            <td>${req.id}</td>
            <td><span class="status-pill status-${req.status}">${req.status}</span></td>
            <td>${req.dateSubmitted}</td>
            <td>${req.firstName}</td>
            <td>${req.lastName}</td>
        `;

        tr.onclick = () => {
            window.location.hash = req.id;
            showDetail(req.id);
        };

        table.appendChild(tr);
    });
}

function showDetail(id) {
    const req = allRequests.find(r => r.id === id);
    if (!req) return;

    document.getElementById("listView").style.display = "none";
    document.getElementById("detailView").style.display = "block";

    document.getElementById("detailContent").innerHTML = `
        <div class="detail-header">FOIA Request ${req.id}</div>

        <div class="detail-grid">
            <div class="label">Status</div><div>${req.status}</div>
            <div class="label">Date Submitted</div><div>${req.dateSubmitted}</div>
            <div class="label">Requester</div><div>${req.firstName} ${req.lastName}</div>
            <div class="label">Email</div><div>${req.email}</div>
            <div class="label">Discord</div><div>${req.discord}</div>
            <div class="label">Jurisdiction</div><div>${req.jurisdiction}</div>
            <div class="label">Department</div><div>${req.department}</div>
            <div class="label">Record Date Range</div><div>${req.startDate} to ${req.endDate}</div>
            <div class="label">Access & Format</div><div>${req.format}</div>
            <div class="label">Delivery Method</div><div>${req.delivery}</div>
            <div class="label">Assigned To</div><div>${req.assigned || "Unassigned"}</div>
        </div>

        <div class="description-box">
            <strong>Description of Records Requested:</strong><br><br>
            ${req.description}
        </div>
    `;
}

function checkHash() {
    const id = window.location.hash.replace("#", "");
    if (id) showDetail(id);
}

window.addEventListener("hashchange", checkHash);

function parseCSV(text) {
    const rows = [];
    const lines = text.split("\n");
    for (let line of lines) {
        const values = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
        if (values) rows.push(values.map(v => v.replace(/^"|"$/g, "").trim()));
    }
    return rows;
}
</script>

</body>
</html>
