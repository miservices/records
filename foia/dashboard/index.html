<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Michigan FOIA Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    margin: 0;
    font-family: Arial, Helvetica, sans-serif;
    background: #f4f6f8;
}

header {
    background: #0e1c32;
    color: white;
    padding: 20px;
    text-align: center;
}

header h1 {
    margin: 0;
    font-size: 24px;
}

main {
    max-width: 1100px;
    margin: 40px auto;
    padding: 0 20px;
}

.card {
    background: white;
    padding: 25px;
    border-radius: 8px;
    box-shadow: 0 4px 18px rgba(0,0,0,.08);
    margin-bottom: 30px;
}

.actions {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

button {
    padding: 12px 18px;
    border: none;
    border-radius: 5px;
    font-weight: bold;
    cursor: pointer;
}

.primary {
    background: #0e1c32;
    color: white;
}

.secondary {
    background: #e1e5eb;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    padding: 14px;
    border-bottom: 1px solid #ddd;
    text-align: left;
}

tr:hover {
    background: #f0f4f8;
    cursor: pointer;
}

.status-badge {
    padding: 6px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    background: #e1e5eb;
}

.detail-view {
    display: none;
}

.detail-grid {
    display: grid;
    grid-template-columns: 200px 1fr;
    gap: 12px 20px;
}

.detail-label {
    font-weight: bold;
    color: #0e1c32;
}

.description-box {
    background: #f7f9fb;
    padding: 15px;
    border-radius: 6px;
    margin-top: 10px;
    line-height: 1.5;
}

.back-link {
    margin-bottom: 20px;
    display: inline-block;
    color: #0e1c32;
    font-weight: bold;
    cursor: pointer;
}
</style>
</head>

<body>

<header>
    <h1>FOIA Dashboard</h1>
</header>

<main>

<div class="card">
    <div class="actions">
        <button class="primary" onclick="newRequest()">Submit FOIA Request</button>
        <button class="secondary" onclick="logout()">Log Out</button>
    </div>
</div>

<div class="card list-view">
    <h2>All FOIA Requests</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Status</th>
                <th>Date Submitted</th>
                <th>First Name</th>
                <th>Last Name</th>
            </tr>
        </thead>
        <tbody id="requestsTable">
            <tr><td colspan="5">Loading...</td></tr>
        </tbody>
    </table>
</div>

<div class="card detail-view" id="detailView">
    <div class="back-link" onclick="goBack()">‚Üê Back to All Requests</div>
    <div id="detailContent"></div>
</div>

</main>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRpPNwgf7vqVsCaG02stM4kRrOsKOAsK_RZXjUnGieqrKJXQzuZvlpC1n1Z7U0kUE36EC3aLnWv677d/pub?output=csv";

let allRequests = [];
let memberLastName = localStorage.getItem("lastName");

document.addEventListener("DOMContentLoaded", async () => {
    if (!memberLastName) {
        alert("Session expired. Please log in again.");
        window.location.href = "/records/foia/login/";
        return;
    }

    await loadRequests();
    checkHash();
});

window.addEventListener("hashchange", checkHash);

async function loadRequests() {
    const table = document.getElementById("requestsTable");

    const response = await fetch(CSV_URL);
    const text = await response.text();
    const rows = parseCSV(text);

    rows.shift(); // remove header

    // Filter by last name (Column D)
    const filtered = rows.filter(row => 
        row[3] && row[3].toLowerCase() === memberLastName.toLowerCase()
    );

    if (filtered.length === 0) {
        table.innerHTML = "<tr><td colspan='5'>No requests found for your account.</td></tr>";
        return;
    }

    allRequests = filtered.map(row => ({
        id: row[0],
        status: row[1],
        firstName: row[2],
        lastName: row[3],
        dateSubmitted: row[4],
        jurisdiction: row[5],
        department: row[6],
        discord: row[7],
        email: row[8],
        description: row[9],
        startDate: row[10],
        endDate: row[11],
        format: row[12],
        delivery: row[13],
        assigned: row[14]
    }));

    table.innerHTML = "";

    allRequests.forEach(req => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${req.id}</td>
            <td><span class="status-badge">${req.status}</span></td>
            <td>${req.dateSubmitted}</td>
            <td>${req.firstName}</td>
            <td>${req.lastName}</td>
        `;
        tr.onclick = () => {
            window.location.hash = req.id;
        };
        table.appendChild(tr);
    });
}

function checkHash() {
    const id = window.location.hash.replace("#", "");
    if (!id) {
        showList();
        return;
    }

    const req = allRequests.find(r => r.id === id);
    if (!req) {
        showList();
        return;
    }

    showDetail(req);
}

function showList() {
    document.querySelector(".list-view").style.display = "block";
    document.getElementById("detailView").style.display = "none";
}

function showDetail(req) {
    document.querySelector(".list-view").style.display = "none";
    document.getElementById("detailView").style.display = "block";

    document.getElementById("detailContent").innerHTML = `
        <h2>FOIA Request ${req.id}</h2>
        <div class="detail-grid">
            <div class="detail-label">Status</div><div>${req.status}</div>
            <div class="detail-label">Date Submitted</div><div>${req.dateSubmitted}</div>
            <div class="detail-label">Requester</div><div>${req.firstName} ${req.lastName}</div>
            <div class="detail-label">Email</div><div>${req.email}</div>
            <div class="detail-label">Discord</div><div>${req.discord}</div>
            <div class="detail-label">Jurisdiction</div><div>${req.jurisdiction}</div>
            <div class="detail-label">Department</div><div>${req.department}</div>
            <div class="detail-label">Records Date Range</div><div>${req.startDate} to ${req.endDate}</div>
            <div class="detail-label">Access & Format</div><div>${req.format}</div>
            <div class="detail-label">Delivery Method</div><div>${req.delivery}</div>
            <div class="detail-label">Assigned To</div><div>${req.assigned}</div>
        </div>

        <h3 style="margin-top:25px;">Description of Records</h3>
        <div class="description-box">
            ${req.description}
        </div>
    `;
}

function parseCSV(text) {
    const rows = [];
    const lines = text.split("\n");
    for (let line of lines) {
        const values = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
        if (values) {
            rows.push(values.map(v => v.replace(/^"|"$/g, "").trim()));
        }
    }
    return rows;
}

function newRequest() {
    window.location.href = "/records/foia/request/new.html";
}

function logout() {
    localStorage.removeItem("lastName");
    window.location.href = "/records/foia/login/";
}
</script>

</body>
</html>
